<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidate Profile Enrichment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-indigo-900 to-purple-900 min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold">Candidate Profile Enrichment</h1>
                        <p class="text-purple-100 text-sm">Auto-discover affiliations, companies, emails & more</p>
                    </div>
                </div>
            </div>

            <!-- Setup Section -->
            <div class="p-6 border-b bg-slate-50">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                    Step 1: API Configuration
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Airtable API Key</label>
                        <input type="password" id="airtableKey" placeholder="patXXXXXXXXXXXXXX" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Airtable Base ID</label>
                        <input type="text" id="airtableBase" placeholder="appXXXXXXXXXXXXXX" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SerpAPI Key (Web Search)</label>
                        <input type="password" id="serpapiKey" placeholder="For Google Scholar & web search" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Apollo.io API Key (Email Finding)</label>
                        <input type="password" id="apolloKey" placeholder="For email discovery" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>

                <button onclick="connect()" id="connectBtn" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all">
                    Connect to Airtable & Load Tables
                </button>
            </div>

            <!-- Candidate Selection -->
            <div id="candidateSection" class="p-6 border-b hidden">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Step 2: Select Candidates to Enrich
                </h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enrichment Mode</label>
                    <div class="flex gap-4 flex-wrap">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="mode" value="single" checked onchange="updateMode()" class="mr-2 text-purple-600">
                            <span class="text-sm">Single Candidate</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="mode" value="missing" onchange="updateMode()" class="mr-2 text-purple-600">
                            <span class="text-sm">All with Missing Data</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="mode" value="all" onchange="updateMode()" class="mr-2 text-purple-600">
                            <span class="text-sm">All Candidates</span>
                        </label>
                    </div>
                </div>

                <div id="singleCandidateSelect" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Candidate</label>
                    <select id="candidateSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Loading candidates...</option>
                    </select>
                </div>

                <div id="batchInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-900">
                        <strong>‚ö° Batch Mode:</strong> Will process multiple candidates automatically. This may take several minutes depending on the number of candidates.
                    </p>
                </div>

                <button onclick="startEnrichment()" id="enrichBtn" disabled class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-semibold py-4 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Start Enrichment Process
                </button>
            </div>

            <!-- Progress -->
            <div id="progressSection" class="p-6 border-b hidden">
                <h3 class="font-semibold mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Enrichment Progress
                </h3>
                <div class="bg-gray-200 rounded-full h-4 mb-2">
                    <div id="progressBar" class="bg-gradient-to-r from-purple-600 to-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-600 text-center">Starting enrichment...</p>
            </div>

            <!-- Logs -->
            <div id="logsSection" class="p-6 bg-slate-50 hidden">
                <h3 class="font-semibold mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Activity Log
                </h3>
                <div id="logsList" class="bg-white rounded-lg border max-h-96 overflow-y-auto"></div>
            </div>

            <!-- Results Summary -->
            <div id="resultsSection" class="p-6 hidden">
                <h3 class="font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Enrichment Summary
                </h3>
                <div id="resultsList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <!-- Instructions -->
            <div id="instructions" class="p-6 bg-purple-50 border-t">
                <h3 class="font-semibold text-purple-900 mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    How It Works
                </h3>
                <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                    <li>Enter your API keys (Airtable, SerpAPI, Apollo.io)</li>
                    <li>Click "Connect to Airtable" to load your candidates and table structure</li>
                    <li>Choose enrichment mode:
                        <ul class="ml-8 mt-1 text-xs space-y-1">
                            <li>‚Ä¢ <strong>Single:</strong> Test on one candidate</li>
                            <li>‚Ä¢ <strong>Missing Data:</strong> Only enrich profiles with missing information</li>
                            <li>‚Ä¢ <strong>All:</strong> Process every candidate (use with caution!)</li>
                        </ul>
                    </li>
                    <li>The tool will automatically search for and update:
                        <ul class="ml-8 mt-1 text-xs space-y-1">
                            <li>üìö Google Scholar Profile</li>
                            <li>üéì PhD Affiliation (university - creates/links in Affiliations table)</li>
                            <li>üè¢ Current Company (creates/links in Companies table)</li>
                            <li>üìß Email Address (via Apollo.io)</li>
                            <li>üíº LinkedIn Profile</li>
                        </ul>
                    </li>
                    <li>All changes are automatically saved to your Airtable with proper linking</li>
                </ol>
                <p class="text-xs text-purple-600 mt-3 font-medium">
                    üí° Tip: Start with a single candidate to verify everything works correctly before running batch operations!
                </p>
            </div>
        </div>
    </div>

    <script>
        let candidates = [];
        let mapping = {};

        function updateMode() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            document.getElementById('singleCandidateSelect').classList.toggle('hidden', mode !== 'single');
            document.getElementById('batchInfo').classList.toggle('hidden', mode === 'single');
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function log(msg, type) {
            type = type || 'info';
            const logsSection = document.getElementById('logsSection');
            const logsList = document.getElementById('logsList');
            logsSection.classList.remove('hidden');
            
            const colorClass = type === 'error' ? 'text-red-600' : 
                               type === 'success' ? 'text-green-600' : 
                               type === 'warning' ? 'text-yellow-600' : 'text-gray-700';
            
            const logEntry = document.createElement('div');
            logEntry.className = 'px-4 py-2 border-b last:border-b-0 text-sm flex items-start gap-2';
            logEntry.innerHTML = '<span class="text-gray-400 text-xs mt-0.5">' + new Date().toLocaleTimeString() + '</span><span class="' + colorClass + ' flex-1">' + msg + '</span>';
            logsList.appendChild(logEntry);
            logsList.scrollTop = logsList.scrollHeight;
        }

        async function connect() {
            const key = document.getElementById('airtableKey').value.trim();
            const base = document.getElementById('airtableBase').value.trim();
            
            if (!key || !base) {
                alert('Please enter Airtable API key and Base ID');
                return;
            }

            try {
                log('Connecting to Airtable...', 'info');
                
                const res = await fetch('https://api.airtable.com/v0/meta/bases/' + base + '/tables', {
                    headers: { 'Authorization': 'Bearer ' + key }
                });

                if (!res.ok) throw new Error('HTTP ' + res.status);

                const data = await res.json();
                
                const cTable = data.tables.find(function(t) { return t.name === 'Candidates'; });
                const aTable = data.tables.find(function(t) { return t.name === 'Affiliations'; });
                const coTable = data.tables.find(function(t) { return t.name === 'Companies'; });
                
                if (!cTable) throw new Error('Candidates table not found');
                
                const candidatesFields = cTable.fields;
                const affiliationsFields = aTable ? aTable.fields : [];
                const companiesFields = coTable ? coTable.fields : [];
                
                mapping.candidateName = candidatesFields.find(function(f) { return f.name.toLowerCase().includes('name'); });
                if (!mapping.candidateName) mapping.candidateName = candidatesFields[0].name;
                else mapping.candidateName = mapping.candidateName.name;
                
                mapping.affiliation = candidatesFields.find(function(f) { return f.name.toLowerCase().includes('affiliation'); });
                if (mapping.affiliation) mapping.affiliation = mapping.affiliation.name;
                
                mapping.company = candidatesFields.find(function(f) { return f.name.toLowerCase().includes('company'); });
                if (mapping.company) mapping.company = mapping.company.name;
                
                mapping.email = candidatesFields.find(function(f) { return f.name.toLowerCase().includes('email'); });
                if (mapping.email) mapping.email = mapping.email.name;
                
                mapping.scholar = candidatesFields.find(function(f) { return f.name.toLowerCase().includes('scholar'); });
                if (mapping.scholar) mapping.scholar = mapping.scholar.name;
                
                mapping.linkedin = candidatesFields.find(function(f) { return f.name.toLowerCase().includes('linkedin'); });
                if (mapping.linkedin) mapping.linkedin = mapping.linkedin.name;
                
                if (affiliationsFields.length > 0) {
                    mapping.affiliationName = affiliationsFields.find(function(f) { return f.name.toLowerCase().includes('name'); });
                    if (!mapping.affiliationName) mapping.affiliationName = affiliationsFields[0].name;
                    else mapping.affiliationName = mapping.affiliationName.name;
                }
                
                if (companiesFields.length > 0) {
                    mapping.companyName = companiesFields.find(function(f) { return f.name.toLowerCase().includes('name'); });
                    if (!mapping.companyName) mapping.companyName = companiesFields[0].name;
                    else mapping.companyName = mapping.companyName.name;
                }
                
                log('‚úì Connected successfully', 'success');
                log('Field mappings configured', 'info');
                
                await loadCandidates(key, base);
                
                document.getElementById('candidateSection').classList.remove('hidden');
                document.getElementById('enrichBtn').disabled = false;
                document.getElementById('instructions').classList.add('hidden');
                
            } catch (error) {
                log('Connection error: ' + error.message, 'error');
            }
        }

        async function loadCandidates(key, base) {
            try {
                log('Loading candidates from Airtable...', 'info');
                
                let allRecords = [];
                let offset = null;

                do {
                    const url = offset 
                        ? 'https://api.airtable.com/v0/' + base + '/Candidates?offset=' + offset
                        : 'https://api.airtable.com/v0/' + base + '/Candidates';
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': 'Bearer ' + key }
                    });

                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    const data = await response.json();
                    allRecords = allRecords.concat(data.records);
                    offset = data.offset;
                } while (offset);

                candidates = allRecords;
                log('‚úì Loaded ' + candidates.length + ' candidates', 'success');
                
                const select = document.getElementById('candidateSelect');
                select.innerHTML = '<option value="">Select a candidate...</option>' +
                    candidates.map(function(c) {
                        return '<option value="' + c.id + '">' + (c.fields[mapping.candidateName] || 'Unnamed') + '</option>';
                    }).join('');
                
            } catch (error) {
                log('Error loading candidates: ' + error.message, 'error');
            }
        }

        async function startEnrichment() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('logsList').innerHTML = '';
            
            if (mode === 'single') {
                const candidateId = document.getElementById('candidateSelect').value;
                if (!candidateId) {
                    alert('Please select a candidate');
                    return;
                }
                const candidate = candidates.find(function(c) { return c.id === candidateId; });
                await enrichCandidate(candidate);
                updateProgress(100, 'Complete!');
            } else {
                let toProcess = candidates;
                if (mode === 'missing') {
                    toProcess = candidates.filter(function(c) {
                        return !c.fields[mapping.email] || 
                               !c.fields[mapping.affiliation] ||
                               !c.fields[mapping.company];
                    });
                }
                
                log('Processing ' + toProcess.length + ' candidates in batch mode...', 'info');
                
                for (let i = 0; i < toProcess.length; i++) {
                    updateProgress((i / toProcess.length) * 100, 'Processing ' + (i + 1) + ' of ' + toProcess.length);
                    await enrichCandidate(toProcess[i]);
                    await new Promise(function(r) { setTimeout(r, 2000); });
                }
                
                updateProgress(100, 'All candidates processed!');
            }
        }

        async function enrichCandidate(candidate) {
            const name = candidate.fields[mapping.candidateName];
            log('‚îÅ‚îÅ‚îÅ Enriching: ' + name + ' ‚îÅ‚îÅ‚îÅ', 'info');
            
            const enrichedData = {};

            // Check if name looks abbreviated (e.g., "J. Michaels")
            const isAbbreviated = /^[A-Z]\.\s/.test(name);
            if (isAbbreviated) {
                log('  ‚Üí Detected abbreviated name, searching for full name...', 'info');
                enrichedData.fullName = await findFullName(name);
            }

            enrichedData.scholar = await findScholarProfile(name);
            const webInfo = await searchWebInfo(enrichedData.fullName || name);
            enrichedData.affiliation = webInfo.affiliation;
            enrichedData.company = webInfo.company;
            enrichedData.linkedin = webInfo.linkedin;
            enrichedData.email = await findEmail(enrichedData.fullName || name, enrichedData.affiliation);
            
            await updateCandidateRecord(candidate.id, enrichedData);
        }

        async function findFullName(abbreviatedName) {
            const serpapiKey = document.getElementById('serpapiKey').value.trim();
            if (!serpapiKey) {
                log('  ‚äò Cannot find full name (no SerpAPI key)', 'warning');
                return null;
            }
            
            try {
                // Search for the person with their abbreviated name
                const response = await fetch('https://serpapi.com/search.json?q=' + encodeURIComponent(abbreviatedName + ' researcher author') + '&api_key=' + serpapiKey);
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const data = await response.json();
                const results = data.organic_results || [];
                
                // Try to extract full name from search results
                for (let i = 0; i < Math.min(results.length, 3); i++) {
                    const result = results[i];
                    const text = result.title + ' ' + result.snippet;
                    
                    // Extract the last name from abbreviated name
                    const lastNameMatch = abbreviatedName.match(/[A-Z]\.\s+([A-Z][a-z]+)/);
                    if (!lastNameMatch) continue;
                    const lastName = lastNameMatch[1];
                    
                    // Look for full name pattern: FirstName LastName
                    const fullNamePattern = new RegExp('\\b([A-Z][a-z]+)\\s+' + lastName + '\\b');
                    const match = text.match(fullNamePattern);
                    
                    if (match) {
                        const fullName = match[0];
                        log('  ‚úì Found full name: ' + fullName, 'success');
                        return fullName;
                    }
                }
                
                // Also check Google Scholar if available
                const scholarResponse = await fetch('https://serpapi.com/search.json?engine=google_scholar_profiles&mauthors=' + encodeURIComponent(abbreviatedName) + '&api_key=' + serpapiKey);
                
                if (scholarResponse.ok) {
                    const scholarData = await scholarResponse.json();
                    if (scholarData.profiles && scholarData.profiles[0]) {
                        const profileName = scholarData.profiles[0].name;
                        // Check if this looks like a full name (not abbreviated)
                        if (profileName && !/^[A-Z]\.\s/.test(profileName)) {
                            log('  ‚úì Found full name from Scholar: ' + profileName, 'success');
                            return profileName;
                        }
                    }
                }
                
                log('  ‚äò Could not find full name', 'warning');
                return null;
            } catch (error) {
                log('  ‚úó Full name search error: ' + error.message, 'error');
                return null;
            }
        }

        async function findScholarProfile(name) {
            const serpapiKey = document.getElementById('serpapiKey').value.trim();
            if (!serpapiKey) {
                log('  ‚äò Skipping Scholar search (no API key)', 'warning');
                return null;
            }
            
            try {
                log('  ‚Üí Searching Google Scholar...', 'info');
                const response = await fetch('https://serpapi.com/search.json?engine=google_scholar_profiles&mauthors=' + encodeURIComponent(name) + '&api_key=' + serpapiKey);
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const data = await response.json();
                if (data.profiles && data.profiles.length > 0) {
                    const profile = data.profiles[0];
                    const scholarUrl = 'https://scholar.google.com/citations?user=' + profile.author_id;
                    log('  ‚úì Found Scholar profile', 'success');
                    return scholarUrl;
                }
                
                log('  ‚äò No Scholar profile found', 'warning');
                return null;
            } catch (error) {
                log('  ‚úó Scholar search error: ' + error.message, 'error');
                return null;
            }
        }

        async function searchWebInfo(name) {
            const serpapiKey = document.getElementById('serpapiKey').value.trim();
            if (!serpapiKey) {
                return { affiliation: null, company: null, linkedin: null };
            }
            
            try {
                log('  ‚Üí Searching web for additional info...', 'info');
                const response = await fetch('https://serpapi.com/search.json?q=' + encodeURIComponent(name + ' PhD researcher') + '&api_key=' + serpapiKey);
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const data = await response.json();
                const results = data.organic_results || [];
                
                let affiliation = null;
                let company = null;
                let linkedin = null;
                
                for (let i = 0; i < Math.min(results.length, 5); i++) {
                    const result = results[i];
                    const text = (result.title + ' ' + result.snippet).toLowerCase();
                    
                    if (result.link && result.link.includes('linkedin.com') && !linkedin) {
                        linkedin = result.link;
                        log('  ‚úì Found LinkedIn profile', 'success');
                    }
                    
                    const universities = ['university', 'institute', 'college', 'MIT', 'Stanford', 'Berkeley', 'CMU'];
                    for (let j = 0; j < universities.length; j++) {
                        if (text.includes(universities[j].toLowerCase()) && !affiliation) {
                            const match = text.match(new RegExp('([A-Z][a-z]+ )*(' + universities[j] + ')( [A-Z][a-z]+)*', 'i'));
                            if (match) {
                                affiliation = match[0];
                                log('  ‚úì Found potential affiliation: ' + affiliation, 'success');
                                break;
                            }
                        }
                    }
                    
                    const companies = ['Google', 'Microsoft', 'Meta', 'OpenAI', 'Anthropic', 'DeepMind', 'Amazon', 'Apple'];
                    for (let k = 0; k < companies.length; k++) {
                        if (text.includes(companies[k].toLowerCase()) && !company) {
                            company = companies[k];
                            log('  ‚úì Found potential company: ' + company, 'success');
                            break;
                        }
                    }
                }
                
                return { affiliation: affiliation, company: company, linkedin: linkedin };
            } catch (error) {
                log('  ‚úó Web search error: ' + error.message, 'error');
                return { affiliation: null, company: null, linkedin: null };
            }
        }

        async function findEmail(name, affiliation) {
            const apolloKey = document.getElementById('apolloKey').value.trim();
            if (!apolloKey) {
                log('  ‚äò Skipping email search (no Apollo API key)', 'warning');
                return null;
            }
            
            try {
                log('  ‚Üí Searching for email via Apollo.io...', 'info');
                
                const response = await fetch('https://api.apollo.io/v1/people/match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': apolloKey
                    },
                    body: JSON.stringify({
                        name: name,
                        organization_name: affiliation
                    })
                });
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const data = await response.json();
                if (data.person && data.person.email) {
                    log('  ‚úì Found email address', 'success');
                    return data.person.email;
                }
                
                log('  ‚äò No email found', 'warning');
                return null;
            } catch (error) {
                log('  ‚úó Email search error: ' + error.message, 'error');
                return null;
            }
        }

        async function getOrCreateAffiliation(affiliationName, apiKey, baseId) {
            if (!affiliationName || !mapping.affiliationName) {
                return null;
            }
            
            try {
                log('    ‚Üí Searching Affiliations table...', 'info');
                const searchUrl = 'https://api.airtable.com/v0/' + baseId + '/Affiliations?filterByFormula=' + 
                    encodeURIComponent('{' + mapping.affiliationName + '} = "' + affiliationName + '"');
                const searchResponse = await fetch(searchUrl, {
                    headers: { 'Authorization': 'Bearer ' + apiKey }
                });

                if (searchResponse.ok) {
                    const searchData = await searchResponse.json();
                    if (searchData.records.length > 0) {
                        log('    ‚Üí ‚úì Found existing affiliation record', 'success');
                        return searchData.records[0].id;
                    }
                }

                log('    ‚Üí Creating new affiliation record...', 'info');
                const createBody = {};
                createBody[mapping.affiliationName] = affiliationName;
                
                const createResponse = await fetch('https://api.airtable.com/v0/' + baseId + '/Affiliations', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fields: createBody })
                });

                if (createResponse.ok) {
                    const createData = await createResponse.json();
                    log('    ‚Üí ‚úì Created new affiliation', 'success');
                    return createData.id;
                } else {
                    const errorData = await createResponse.json();
                    log('    ‚Üí ‚úó Failed to create affiliation: ' + errorData.error.message, 'error');
                }
            } catch (error) {
                log('    ‚Üí ‚úó Exception: ' + error.message, 'error');
            }
            return null;
        }

        async function getOrCreateCompany(companyName, apiKey, baseId) {
            if (!companyName || !mapping.companyName) {
                return null;
            }
            
            try {
                log('    ‚Üí Searching Companies table...', 'info');
                const searchUrl = 'https://api.airtable.com/v0/' + baseId + '/Companies?filterByFormula=' + 
                    encodeURIComponent('{' + mapping.companyName + '} = "' + companyName + '"');
                const searchResponse = await fetch(searchUrl, {
                    headers: { 'Authorization': 'Bearer ' + apiKey }
                });

                if (searchResponse.ok) {
                    const searchData = await searchResponse.json();
                    if (searchData.records.length > 0) {
                        log('    ‚Üí ‚úì Found existing company record', 'success');
                        return searchData.records[0].id;
                    }
                }

                log('    ‚Üí Creating new company record...', 'info');
                const createBody = {};
                createBody[mapping.companyName] = companyName;
                
                const createResponse = await fetch('https://api.airtable.com/v0/' + baseId + '/Companies', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fields: createBody })
                });

                if (createResponse.ok) {
                    const createData = await createResponse.json();
                    log('    ‚Üí ‚úì Created new company', 'success');
                    return createData.id;
                } else {
                    const errorData = await createResponse.json();
                    log('    ‚Üí ‚úó Failed to create company: ' + errorData.error.message, 'error');
                }
            } catch (error) {
                log('    ‚Üí ‚úó Exception: ' + error.message, 'error');
            }
            return null;
        }

        async function updateCandidateRecord(candidateId, enrichedData) {
            const apiKey = document.getElementById('airtableKey').value.trim();
            const baseId = document.getElementById('airtableBase').value.trim();
            
            try {
                const fields = {};
                
                // Update full name if found
                if (enrichedData.fullName && mapping.candidateName) {
                    fields[mapping.candidateName] = enrichedData.fullName;
                    log('  ‚úì Will update to full name: ' + enrichedData.fullName, 'success');
                }
                
                if (enrichedData.email && mapping.email) {
                    fields[mapping.email] = enrichedData.email;
                }
                if (enrichedData.scholar && mapping.scholar) {
                    fields[mapping.scholar] = enrichedData.scholar;
                }
                if (enrichedData.linkedin && mapping.linkedin) {
                    fields[mapping.linkedin] = enrichedData.linkedin;
                }
                
                if (enrichedData.affiliation && mapping.affiliation) {
                    log('  ‚Üí Processing affiliation linking...', 'info');
                    const affiliationId = await getOrCreateAffiliation(enrichedData.affiliation, apiKey, baseId);
                    if (affiliationId) {
                        fields[mapping.affiliation] = [affiliationId];
                        log('  ‚úì Affiliation linked successfully', 'success');
                    }
                }
                
                if (enrichedData.company && mapping.company) {
                    log('  ‚Üí Processing company linking...', 'info');
                    const companyId = await getOrCreateCompany(enrichedData.company, apiKey, baseId);
                    if (companyId) {
                        fields[mapping.company] = [companyId];
                        log('  ‚úì Company linked successfully', 'success');
                    }
                }
                
                if (Object.keys(fields).length === 0) {
                    log('  ‚äò No new data to update', 'warning');
                    return;
                }
                
                log('  ‚Üí Updating candidate record with ' + Object.keys(fields).length + ' fields...', 'info');
                
                const response = await fetch('https://api.airtable.com/v0/' + baseId + '/Candidates/' + candidateId, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fields: fields })
                });
                
                if (response.ok) {
                    log('  ‚úì Candidate profile updated successfully!', 'success');
                } else {
                    const error = await response.json();
                    log('  ‚úó Update failed: ' + error.error.message, 'error');
                }
                
            } catch (error) {
                log('  ‚úó Update error: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>